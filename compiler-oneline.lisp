(DEFINE EMIT (LAMBDA (P B) (PROGN (POKE P B) (+ P 1))))
(DEFINE EMIT16 (LAMBDA (P W) (EMIT (EMIT P (% W 256)) (/ W 256))))
(DEFINE LDHLNN (LAMBDA (P N) (EMIT16 (EMIT P 33) N)))
(DEFINE PUSHHL (LAMBDA (P) (EMIT P 229)))
(DEFINE POPHL (LAMBDA (P) (EMIT P 225)))
(DEFINE POPDE (LAMBDA (P) (EMIT P 209)))
(DEFINE ADDHLDE (LAMBDA (P) (EMIT P 25)))
(DEFINE SBCHLDE (LAMBDA (P) (EMIT (EMIT P 237) 82)))
(DEFINE ORA (LAMBDA (P) (EMIT P 183)))
(DEFINE HALTZ (LAMBDA (P) (EMIT P 118)))
(DEFINE TAGFIX 1)
(DEFINE MKFIX (LAMBDA (N) (+ (* N 4) TAGFIX)))
(DEFINE CNUM (LAMBDA (P N) (LDHLNN P (MKFIX N))))
(DEFINE CADD (LAMBDA (P X Y) (LET ((Q (CEXP P X))) (LET ((R (PUSHHL Q))) (LET ((S (CEXP R Y))) (LET ((U (POPDE S))) (LET ((V (ADDHLDE U))) (LET ((W (LDHLNN V 1))) (SBCHLDE (ORA (POPDE W)))))))))))
(DEFINE CSUB (LAMBDA (P X Y) (LET ((Q (CEXP P Y))) (LET ((R (PUSHHL Q))) (LET ((S (CEXP R X))) (LET ((U (POPDE S))) (LET ((V (ORA U))) (LET ((W (SBCHLDE V))) (ADDHLDE (LDHLNN W 1))))))))))
(DEFINE CAPPLY (LAMBDA (P F A) (COND ((EQ F '+) (CADD P (CAR A) (CAR (CDR A)))) ((EQ F '-) (CSUB P (CAR A) (CAR (CDR A)))) (T P))))
(DEFINE CEXP (LAMBDA (P E) (COND ((NUMBERP E) (CNUM P E)) ((CONSP E) (CAPPLY P (CAR E) (CDR E))) (T P))))
(DEFINE COMPILE (LAMBDA (E) (- (HALTZ (CEXP 256 E)) 256)))
(PRINT '(Compiling...))
(PRINT (LIST 'Generated (COMPILE '(+ 1 2)) 'bytes))
(PRINT '(Dumping...))
(DUMP 256 32)
(PRINT 'Done)
